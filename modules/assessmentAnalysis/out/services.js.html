<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileOverview Serviços do módulo assessmentAnalysis
 */

//  usa baseURL do módulo principal
angular.module("assessmentAnalysis")
    //
    .service("AssessmentFactory", ["$http", "baseURL", "$q",
        function ($http, baseURL, $q) {

            var no_cache = function () {
                return "?no_cache=" + new Date().toString();
            };

            this.getAssessmentList = function () {
                return $http.get(baseURL + "database/assessmentData/answerSheets.json" + no_cache()).then(
                    function (response) {
                        return response.data;
                    },
                    function (response) {
                        alert("Erro no recebimento de dados... recarregue a página.");
                        return $q.reject();
                    });
            };

            this.getAssessment = function (assessmentId) {
                if (typeof assessmentId === "string") {
                    assessmentId = parseInt(assessmentId);
                }
                return this.getAssessmentList().then(
                    function (response) {
                        for (var i = 0; i &lt; response.length; i++) {
                            if (response[i].assessmentId === assessmentId) {
                                return response[i];
                            }
                        }
                        //  Se não encontrar a prova procurada,
                        return $q.reject();
                    },
                    function (response) {
                        return $q.reject();
                    });
            };

            this.uploadAnswers = function (answerObj) {
                return $http.post(baseURL + "database/post.php", answerObj).then(
                    function (response) {
                        console.debug(response);
                    }
                );
            };

        }
    ])
    //
    .service("AnswerRecordFactory", ["$http", "baseURL", "$q",
        function ($http, baseURL, $q) {

            var no_cache = function () {
                return "?no_cache=" + new Date().toString();
            };

            this.getRecord = function () {
                return $http.get(baseURL + "database/assessmentData/userAnswers.json" + no_cache()).then(
                    function (response) {
                        return response.data;
                    },
                    function (response) {
                        alert("Erro no recebimento de dados... recarregue a página.");
                        return $q.reject();
                    }
                );
            };

            this.getUserAnswers = function (username, assessmentId) {
                if (typeof assessmentId === "string") {
                    assessmentId = parseInt(assessmentId);
                }
                return this.getRecord().then(
                    function (allUsersRecord) {
                        for (var i = 0; i &lt; allUsersRecord.length; i++) {
                            if (allUsersRecord[i].username === username &amp;&amp; allUsersRecord[i].assessmentId === assessmentId) {
                                return allUsersRecord[i];
                            }
                        }
                        return $q.reject();
                    },
                    function (response) {
                        return $q.reject();
                    }
                );
            };

        }
    ])
    //
    .service("StatisticsFactory", ["$q", "AssessmentFactory", "AnswerRecordFactory",
        function ($q, AssessmentFactory, AnswerRecordFactory) {

            this.getUserList = function (assessmentId) {
                if (typeof assessmentId === "string") {
                    assessmentId = parseInt(assessmentId);
                }
                var userList = [];
                AnswerRecordFactory.getRecord().then(
                    function (response) {
                        if (!response) {
                            return [];
                        }
                        response.forEach(function (current, index, array) {
                            if (!userList.includes(current.username) &amp;&amp; current.assessmentId === assessmentId) {
                                userList.push(current.username);
                            }
                        });
                    }
                );
                return userList;
            };

            this.getEvaluatedQuestions = function (assessmentId, username) {
                var correctAnswers = [];
                var userAnswers = [];

                return $q.all([
                    AssessmentFactory.getAssessment(assessmentId).then(
                            function (desiredAssessment) {
                                correctAnswers = desiredAssessment.questions;
                            },
                            function () {
                                return $q.reject();
                            }
                    ),
                    AnswerRecordFactory.getUserAnswers(username, assessmentId).then(
                            function (_userAnswers_) {
                                userAnswers = _userAnswers_;
                            },
                            function () {
                                return $q.reject();
                            }
                    )
                ])
                    .then(
                        function () {
                            var evaluatedQuestionList = [];
                            correctAnswers.forEach(function (current, index, array) {
                                evaluatedQuestionList.push({
                                    questionNumber: current.questionNumber,
                                    correctAnswer: current.correctAnswer,
                                    userAnswer: userAnswers.answerList[index].answer,
                                    subject: current.subject
                                });
                            });
                            return evaluatedQuestionList;
                        },
                        function () {
                            return $q.reject();
                        }
                    );
            };

            this.getSortedQuestions = function (assessmentId, username) {
                return this.getEvaluatedQuestions(assessmentId, username).then(
                    function (evaluatedQuestionList) {
                        /**
                         * Lista de strings (cada uma é uma matéria)
                         *
                         * @type       {Array}
                         */
                        var subjectList = [];
                        evaluatedQuestionList.forEach(
                            function (current, index, array) {
                                if (!subjectList.includes(current.subject)) {
                                    subjectList.push(current.subject);
                                }
                            }
                        );

                        /**
                         * Array de objetos. Cada um tem uma string "matéria", um Array de
                         * questões dela e um Int que conta quantas questões estão
                         * corretamente respondidas
                         *
                         * @type       {Array}
                         */
                        var sortedQuestionList = [];
                        subjectList.forEach(function (current, index, array) {
                            sortedQuestionList.push({
                                subject: current,
                                questionList: [],
                                correctCount: 0
                            });
                        });
                        //  Preenche sortedQuestionList
                        sortedQuestionList.forEach(function (currentQuestionList, index, array) {
                            var currentSubject = currentQuestionList.subject;
                            for (var i = 0; i &lt; evaluatedQuestionList.length; i++) {
                                if (evaluatedQuestionList[i].subject === currentSubject) {
                                    currentQuestionList.questionList.push(evaluatedQuestionList[i]);
                                }
                            }
                        });
                        //  Coloca questões certas na frente. Tudo em ordem alfabética
                        for (var i = 0; i &lt; sortedQuestionList.length; i++) {
                            sortedQuestionList[i].questionList.sort(
                                function (a, b) {
                                    if (a.userAnswer === a.correctAnswer &amp;&amp; b.userAnswer !== b.correctAnswer) {
                                        return -1;
                                    } else if (a.userAnswer !== a.correctAnswer &amp;&amp; b.userAnswer === b.correctAnswer) {
                                        return 1;
                                    } else if (a.questionNumber &lt; b.questionNumber) {
                                        return -1;
                                    }
                                    return +1;
                                }
                            );
                        }
                        //  Conta quantas questões estão certas, em cada matéria
                        for (var i = 0; i &lt; sortedQuestionList.length; i++) {
                            for (var j = 0; j &lt; sortedQuestionList[i].questionList.length &amp;&amp; sortedQuestionList[i].questionList[j].userAnswer === sortedQuestionList[i].questionList[j].correctAnswer; j++) {
                                sortedQuestionList[i].correctCount++;
                            }
                        }

                        return sortedQuestionList;
                    },
                    function () {
                        return $q.reject();
                    }
                );

            };

        }
    ]);</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sun Sep 04 2016 13:06:00 GMT-0400 (Hora Padrão Brasil Central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
